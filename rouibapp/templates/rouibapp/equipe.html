{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Équipes</title>
    <link rel="stylesheet" href="{% static 'rouibapp/home.css' %}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="{% static 'rouibapp/equipe.js' %}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            background: url("{% static 'rouibapp/back.png' %}") no-repeat center center fixed;
            background-size: cover;
        }
        .stats-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 30px 0;
            padding: 0 20px;
        }
        .main-content {
            background: rgba(255, 255, 255, 0.18); /* blanc transparent */
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(0,0,0,0.08);
            padding: 20px;
        }
        .content-body {
            background: rgba(255, 255, 255, 0.18); /* blanc transparent */
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            padding: 20px;
        }
        .bg-primary {
            background-color: #198754 !important;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <button class="toggle-btn" onclick="toggleSidebar()">
        <i class="fas fa-chevron-left" id="toggleIcon"></i>
    </button>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            
            <img src="{% static 'rouibapp/Logo_Rouiba.png' %}" 
                alt="Logo Rouiba" 
                class="logo-rouiba">
            <small>Panel d'administration</small>
        </div>
        
        <ul class="nav-menu">
            <li>
                <a href="{% url 'home' %}">
                    <i class="fas fa-home"></i>
                    <span>Accueil</span>
                </a>
            </li>
            <li>
                <a href="{% url 'statistiques' %}">
                    <i class="fas fa-chart-bar"></i>
                    <span>Statistiques</span>
                </a>
            </li>
            <li>
                <a href="{% url 'equipe' %}" class="active">
                    <i class="fas fa-users"></i>
                    <span>Équipes</span>
                </a>
            </li>
            <li>
                <a href="#" onclick="toggleSubmenu(event)">
                    <i class="fas fa-box"></i>
                    <span>Produits</span>
                    <i class="fas fa-chevron-down submenu-arrow"></i>
                </a>
                <ul class="submenu">
                    <li><a href="{% url 'carton' %}"><span>Carton</span></a></li>
                    <li><a href="{% url 'PET' %}"><span>PET</span></a></li>
                </ul>
            </li>
            <li>
                <a href="{% url 'logout' %}">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Déconnexion</span>
                </a>
            </li>
        </ul>
    </div>
    
    <div class="main-content" id="mainContent">
        <div class="content-header" >
            <img src="{% static 'rouibapp/jus.png' %}" alt="Jus" class="header-img">
        </div>

        <div class="content-body">
            <div class="container mt-4">
                <!-- Affichage des messages -->
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2>Liste des employés</h2>
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#ajoutEmployeModal">
                        <i class="fas fa-plus"></i> Ajouter un employé
                    </button>
                </div>

                <!-- Modal d'ajout d'employé -->
                <div class="modal fade" id="ajoutEmployeModal" tabindex="-1" aria-labelledby="ajoutEmployeModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form method="post" action="{% url 'ajouter_employe' %}">
                                {% csrf_token %}
                                <div class="modal-header">
                                    <h5 class="modal-title" id="ajoutEmployeModalLabel">Ajouter un employé</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="nom" class="form-label fw-bold">Nom</label>
                                        <input type="text" class="form-control" id="nom" name="nom" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="prenom" class="form-label fw-bold">Prénom</label>
                                        <input type="text" class="form-control" id="prenom" name="prenom" required>
                                    </div>
                                    <!-- ✅ CHAMP TYPE_EQUIPE AJOUTÉ -->
                                    <div class="mb-3">
                                        <label for="type_equipe" class="form-label fw-bold">Type d'équipe</label>
                                        <select class="form-control" id="type_equipe" name="type_equipe" required>
                                            <option value="">-- Sélectionner une équipe --</option>
                                            <option value="CARTON">Carton</option>
                                            <option value="PET">PET</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                                    <button type="submit" class="btn btn-success">Ajouter</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Modal pour modifier un employé Carton -->
                <div class="modal fade" id="modifierEmployeModal" tabindex="-1" aria-labelledby="modifierEmployeModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form method="post" id="formModifierEmploye">
                                {% csrf_token %}
                                <div class="modal-header">
                                    <h5 class="modal-title" id="modifierEmployeModalLabel">Modifier l'employé</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="nom_mod" class="form-label fw-bold">Nom</label>
                                        <input type="text" class="form-control" id="nom_mod" name="nom" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="prenom_mod" class="form-label fw-bold">Prénom</label>
                                        <input type="text" class="form-control" id="prenom_mod" name="prenom" required>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                                    <button type="submit" class="btn btn-success">Modifier</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- ✅ SECTION CORRIGÉE : Deux équipes séparées -->
                <div class="row">
                    <!-- Équipe Carton -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-box"></i> Équipe Carton
                                    <span class="badge bg-light text-dark ms-2">{{ equipe_carton|length }}</span>
                                </h5>
                            </div>
                            <div class="card-body">
                                {% if equipe_carton %}
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Nom</th>
                                                    <th>Prénom</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for employe in equipe_carton %}
                                                <tr>
                                                    <td>{{ employe.nom }}</td>
                                                    <td>{{ employe.prenom }}</td>
                                                    <td>
                                                        <button class="btn btn-warning btn-sm" 
                                                            data-id="{{ employe.id_equipe }}" 
                                                            data-nom="{{ employe.nom }}" 
                                                            data-prenom="{{ employe.prenom }}" 
                                                            onclick="modifierEmploye(this)"
                                                            title="Modifier">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <form method="post" action="{% url 'supprimer_employe' employe.id_equipe %}" style="display:inline;" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer {{ employe.prenom }} {{ employe.nom }} ?')">
                                                            {% csrf_token %}
                                                            <button type="submit" class="btn btn-danger btn-sm" title="Supprimer">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </form>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    <div class="text-center py-4">
                                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">Aucun employé dans l'équipe Carton</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Équipe PET -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-recycle"></i> Équipe PET
                                    <span class="badge bg-light text-dark ms-2">{{ equipe_pet|length }}</span>
                                </h5>
                            </div>
                            <div class="card-body">
                                {% if equipe_pet %}
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Nom</th>
                                                    <th>Prénom</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for employe in equipe_pet %}
                                                <tr>
                                                    <td>{{ employe.nom }}</td>
                                                    <td>{{ employe.prenom }}</td>
                                                    <td>
                                                        <button class="btn btn-warning btn-sm" 
                                                            data-id="{{ employe.id_equipe }}" 
                                                            data-nom="{{ employe.nom }}" 
                                                            data-prenom="{{ employe.prenom }}"
                                                            onclick="modifierEmployePET(this)"
                                                            title="Modifier">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button class="btn btn-danger btn-sm" 
                                                            onclick="confirmerSuppressionPET('{{ employe.nom }}', '{{ employe.prenom }}', '{{ employe.id_equipe }}')"
                                                            title="Supprimer">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    <div class="text-center py-4">
                                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">Aucun employé dans l'équipe PET</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ✅ JAVASCRIPT CORRIGÉ -->
    <script>
        // Fonction pour modifier un employé CARTON
        function modifierEmploye(button) {
            const id = button.dataset.id;
            const nom = button.dataset.nom;
            const prenom = button.dataset.prenom;
            
            // Remplir le formulaire avec les données actuelles
            document.getElementById('nom_mod').value = nom;
            document.getElementById('prenom_mod').value = prenom;
            
            // Définir l'action du formulaire pour CARTON
            document.getElementById('formModifierEmploye').action = `/modifier_employe/${id}/`;
            
            // Ouvrir la modal
            new bootstrap.Modal(document.getElementById('modifierEmployeModal')).show();
        }

        // Fonction pour modifier un employé PET
        function modifierEmployePET(button) {
            const id = button.dataset.id;
            const nom = button.dataset.nom;
            const prenom = button.dataset.prenom;
            
            // Remplir le formulaire avec les données actuelles
            document.getElementById('nom_mod').value = nom;
            document.getElementById('prenom_mod').value = prenom;
            
            // Définir l'action du formulaire pour PET
            document.getElementById('formModifierEmploye').action = `/modifier_employe_pet/${id}/`;
            
            // Ouvrir la modal
            new bootstrap.Modal(document.getElementById('modifierEmployeModal')).show();
        }

        // Fonction pour supprimer un employé CARTON
        function confirmerSuppressionCarton(nom, prenom, id) {
            if (confirm(`Êtes-vous sûr de vouloir supprimer ${prenom} ${nom} de l'équipe Carton ?`)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/supprimer_employe/${id}/`;
                
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = csrfToken;
                
                form.appendChild(csrfInput);
                document.body.appendChild(form);
                form.submit();
            }
        }

        // Fonction pour supprimer un employé PET
        function confirmerSuppressionPET(nom, prenom, id) {
            if (confirm(`Êtes-vous sûr de vouloir supprimer ${prenom} ${nom} de l'équipe PET ?`)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/supprimer_employe_pet/${id}/`;
                
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = csrfToken;
                
                form.appendChild(csrfInput);
                document.body.appendChild(form);
                form.submit();
            }
        }

        // Auto-hide alerts after 5 seconds
        document.addEventListener('DOMContentLoaded', function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(function(alert) {
                setTimeout(function() {
                    if (alert && alert.parentNode) {
                        alert.classList.remove('show');
                        setTimeout(function() {
                            alert.remove();
                        }, 150);
                    }
                }, 5000);
            });
        });
    </script>
</body>
</html>